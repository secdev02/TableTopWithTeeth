using System;
using System.IO;
using System.Text;
using System.IO.Compression;
using System.EnterpriseServices;
using System.Collections.Generic;
using System.Runtime.InteropServices;
using System.Security.Cryptography;
 
/*
Author: Casey Smith, Twitter: @subTee
License: BSD 3-Clause
 
C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /r:System.IO.Compression.dll genericBuilder.cs 

*/
 
namespace Delivery
{
 
	public class Program
	{
		public static int Main(string[] args)
		{
			
			if (args.Length == 0)
			{
				Console.WriteLine("usage: genericBuilder.exe inputFile outPutFile, key");
				return -1;
			}
			
			// Builder Shit
			Console.Write("Creates an encrypted bytes stream");
            byte[] b  = Misc.FileToByteArray(args[0]);
            byte[] e = Misc.Encrypt(b,"atomic"); //You can easily decouple the key from the code here.  Just for PoC
            string f = System.Convert.ToBase64String(e);
            File.WriteAllText(args[1],f);
            Console.WriteLine("Finished");
			return 0;
		}
		
		
	}
  
   
   
    public class Misc
    {
        //Change This!
        private static readonly byte[] SALT = new byte[] { 0xba, 0xdc, 0x0f, 0xfe, 0xeb, 0xad, 0xbe, 0xfd, 0xea, 0xdb, 0xac, 0xdc, 0xdc, 0xac, 0xac, 0xdc };
 
        public static void Stage(string fileName, string Key, string outFile)
        {
 
            byte[] raw = FileToByteArray(fileName);
            byte[] file = Encrypt(raw, Key);
 
            FileStream fileStream = File.Create(outFile);
 
            fileStream.Write(file, 0, file.Length);//Write stream to temp file
 
            Console.WriteLine("File Ready, Now Deliver Payload");
 
        }
 
        public static byte[] FileToByteArray(string _FileName)
        {
            byte[] _Buffer = null;
            System.IO.FileStream _FileStream = new System.IO.FileStream(_FileName, System.IO.FileMode.Open, System.IO.FileAccess.Read);
            System.IO.BinaryReader _BinaryReader = new System.IO.BinaryReader(_FileStream);
            long _TotalBytes = new System.IO.FileInfo(_FileName).Length;
            _Buffer = _BinaryReader.ReadBytes((Int32)_TotalBytes);
            _FileStream.Close();
            _FileStream.Dispose();
            _BinaryReader.Close();
            return _Buffer;
        }
 
        public static byte[] Encrypt(byte[] plain, string password)
        {
            MemoryStream memoryStream;
            CryptoStream cryptoStream;
            Rijndael rijndael = Rijndael.Create();
            Rfc2898DeriveBytes pdb = new Rfc2898DeriveBytes(password, SALT);
            rijndael.Key = pdb.GetBytes(32);
            rijndael.IV = pdb.GetBytes(16);
            memoryStream = new MemoryStream();
            cryptoStream = new CryptoStream(memoryStream, rijndael.CreateEncryptor(), CryptoStreamMode.Write);
            cryptoStream.Write(plain, 0, plain.Length);
            cryptoStream.Close();
            return memoryStream.ToArray();
        }
        public static byte[] Decrypt(byte[] cipher, string password)
        {
            MemoryStream memoryStream;
            CryptoStream cryptoStream;
            Rijndael rijndael = Rijndael.Create();
            Rfc2898DeriveBytes pdb = new Rfc2898DeriveBytes(password, SALT);
            rijndael.Key = pdb.GetBytes(32);
            rijndael.IV = pdb.GetBytes(16);
            memoryStream = new MemoryStream();
            cryptoStream = new CryptoStream(memoryStream, rijndael.CreateDecryptor(), CryptoStreamMode.Write);
            cryptoStream.Write(cipher, 0, cipher.Length);
            cryptoStream.Close();
            return memoryStream.ToArray();
        }
 
        public static byte[] ReadFully(Stream input) //Returns Byte Array From Stream 
        {
            byte[] buffer = new byte[16 * 1024];
            using (MemoryStream ms = new MemoryStream())
            {
                int read;
                while ((read = input.Read(buffer, 0, buffer.Length)) > 0)
                {
                    ms.Write(buffer, 0, read);
                }
                return ms.ToArray();
            }
        }
 
    }//End Misc Class
 
    
}